<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">

  <!-- Responsive: fondamentale per Google Sites e mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Mappa avvistamenti</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>

  <!-- Stili base -->
<style>
  html, body {
    height: 100%;
    margin: 0;
  }

  /* Contenitore mappa */
  #map {
    height: 100vh;
    width: 100%;
  }

  /* Legenda */
  .legend {
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 6px;
    box-shadow: 0 0 6px rgba(0,0,0,0.3);
    font-size: 14px;
    pointer-events: auto;
  }

  .legend-item {
    cursor: pointer;
    margin-bottom: 4px;
    user-select: none;
  }

  .legend-item.disabled {
    opacity: 0.4;
    text-decoration: line-through;
  }
</style>
  
</head>

<body>

<!-- Selettore modalità -->
<div class="controls">
  <label>
    Colorazione:
    <select id="modeSelect">
      <option value="year">Data avvistamento</option>
      <option value="age">Età presunta</option>
    </select>
  </label>
</div>

<!-- Mappa -->
<div id="map"></div>

<!-- Legenda -->
<div id="legend" class="legend"></div>

<script>
/* ===============================
   1. CONFIGURAZIONE BASE
   =============================== */

// URL CSV pubblicato del foglio "Dati mappa"
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQV5vkNteaZi31wNAuMVEvaBVyETWETC9C3R01wmtB_JaoSgXPasKPS9ZdjrrN9j4gPjv-_ZoOeWpkS/pub?gid=602128412&single=true&output=csv";

// Colori predefiniti (usati in rotazione)
const COLOR_PALETTE = [
  "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728",
  "#9467bd", "#8c564b", "#e377c2", "#7f7f7f",
  "#bcbd22", "#17becf"
];

// Colore per dato mancante
const COLOR_MISSING = "#999999";

// Insieme dei filtri attivi
let activeFilters = new Set();

// Tutti i marker caricati
let markersData = [];

// Modalità corrente ("year" o "age")
let currentMode = "year";

/* ===============================
   2. INIZIALIZZA MAPPA
   =============================== */

const map = L.map("map").setView(
  [45.1370, 7.0480], // Valle di Susa
  10
);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

/* ===============================
   3. FUNZIONI DI SUPPORTO
   =============================== */

// Converte "13/12/2025" → 2025
function getYearFromItalianDate(value) {
  if (!value) return null;
  const parts = value.split("/");
  if (parts.length !== 3) return null;
  return parts[2];
}

// Restituisce la categoria in base alla modalità
function getCategory(row) {
  if (currentMode === "year") {
    return getYearFromItalianDate(row.Data) || "Non disponibile";
  } else {
    return row.Età || "Non determinato";
  }
}

/* ===============================
   4. CARICAMENTO DATI CSV
   =============================== */

async function loadData() {
  const response = await fetch(CSV_URL);
  const text = await response.text();

  const rows = text.trim().split("\n");
  const headers = rows[0].split(",");

  // Pulisce eventuali marker precedenti
  markersData.forEach(obj => map.removeLayer(obj.marker));
  markersData = [];

  const categoriesSet = new Set();

  for (let i = 1; i < rows.length; i++) {
    const values = rows[i].split(",");
    const row = {};
    headers.forEach((h, idx) => row[h] = values[idx]);

    const lat = parseFloat(row.Latitudine);
    const lng = parseFloat(row.Longitudine);

    // Esclude coordinate non valide
    if (isNaN(lat) || isNaN(lng)) continue;

    const category = getCategory(row);
    categoriesSet.add(category);

    const marker = L.circleMarker([lat, lng], {
      radius: 7,
      color: "#000",
      weight: 1,
      fillOpacity: 0.9
    }).addTo(map);

    marker.bindPopup(
      `<b>Data:</b> ${row.Data || "—"}<br>
       <b>Età:</b> ${row.Età || "—"}`
    );

    markersData.push({ marker, category });
  }

  updateColors(categoriesSet);
  updateLegend(categoriesSet);
}

/* ===============================
   5. COLORAZIONE MARKER
   =============================== */

function updateColors(categoriesSet) {
  const categories = Array.from(categoriesSet);
  const colorMap = {};

  categories.forEach((cat, i) => {
    colorMap[cat] =
      (cat === "Non disponibile" || cat === "Non determinato")
      ? COLOR_MISSING
      : COLOR_PALETTE[i % COLOR_PALETTE.length];
  });

  markersData.forEach(obj => {
    const visible =
      activeFilters.size === 0 || activeFilters.has(obj.category);

    obj.marker.setStyle({
      fillColor: colorMap[obj.category],
      fillOpacity: visible ? 0.9 : 0
    });
  });
}

/* ===============================
   6. LEGENDA + FILTRI
   =============================== */

function updateLegend(categoriesSet) {
  const legend = document.getElementById("legend");
  legend.innerHTML = `<b>${
    currentMode === "year" ? "Anno di avvistamento" : "Età presunta"
  }</b><br><br>`;

  const categories = Array.from(categoriesSet).sort();

  categories.forEach((cat, i) => {
    const color =
      (cat === "Non disponibile" || cat === "Non determinato")
      ? COLOR_MISSING
      : COLOR_PALETTE[i % COLOR_PALETTE.length];

    const item = document.createElement("div");
    item.className = "legend-item";

    if (activeFilters.size > 0 && !activeFilters.has(cat)) {
      item.classList.add("inactive");
    }

    item.innerHTML = `
      <div class="legend-color" style="background:${color}"></div>
      <span>${cat}</span>
    `;

    // Click = toggle filtro
    item.onclick = () => {
      if (activeFilters.has(cat)) {
        activeFilters.delete(cat);
      } else {
        activeFilters.add(cat);
      }
      updateColors(categoriesSet);
      updateLegend(categoriesSet);
    };

    legend.appendChild(item);
  });
}

/* ===============================
   7. CAMBIO MODALITÀ
   =============================== */

document.getElementById("modeSelect").addEventListener("change", e => {
  currentMode = e.target.value;
  activeFilters.clear();
  loadData();
});

/* ===============================
   8. AVVIO
   =============================== */

loadData();

</script>
</body>
</html>
