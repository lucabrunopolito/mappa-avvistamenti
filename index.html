<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<title>Mappa avvistamenti</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body {
    margin: 0;
    height: 100%;
  }

  #map {
    width: 100%;
    height: 100vh;
  }

  .controls {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    background: white;
    padding: 8px;
    border-radius: 6px;
    box-shadow: 0 0 6px rgba(0,0,0,0.3);
    font-family: sans-serif;
  }

  .legend {
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 6px;
    box-shadow: 0 0 6px rgba(0,0,0,0.3);
    font-family: sans-serif;
    font-size: 13px;
  }

  .legend-item {
    cursor: pointer;
    margin-bottom: 4px;
  }

  .legend-item span {
    display: inline-block;
    width: 14px;
    height: 14px;
    margin-right: 6px;
    vertical-align: middle;
  }

  .legend-item.disabled {
    opacity: 0.4;
  }
</style>
</head>

<body>

<div id="map"></div>

<div class="controls">
  <label>
    Colora per:
    <select id="modeSelect">
      <option value="date">Data avvistamento</option>
      <option value="age">Età presunta</option>
    </select>
  </label>
</div>

<div id="legend" class="legend"></div>

<script>
/* ======================================================
   CONFIGURAZIONE
====================================================== */

const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQV5vkNteaZi31wNAuMVEvaBVyETWETC9C3R01wmtB_JaoSgXPasKPS9ZdjrrN9j4gPjv-_ZoOeWpkS/pub?gid=602128412&single=true&output=csv";

/* ======================================================
   MAPPA
====================================================== */

const map = L.map("map").setView([45.1370, 7.0480], 10);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

/* ======================================================
   STATO
====================================================== */

let markersData = [];
let activeCategories = new Set();
let currentMode = "date";

/* ======================================================
   UTILITY
====================================================== */

function normalize(value) {
  if (!value) return null;
  value = value.trim();
  if (value === "" || value.toLowerCase() === "undefined") return null;
  return value;
}

function getYearFromItalianDate(dateStr) {
  if (!dateStr) return null;
  const parts = dateStr.split("/");
  if (parts.length !== 3) return null;
  const year = parseInt(parts[2], 10);
  return isNaN(year) ? null : year.toString();
}

function colorForCategory(category, index) {
  const palette = [
    "#1f78b4", "#33a02c", "#e31a1c", "#ff7f00",
    "#6a3d9a", "#b15928", "#a6cee3", "#b2df8a"
  ];
  if (!category) return "#999";
  return palette[index % palette.length];
}

/* ======================================================
   CARICAMENTO DATI
====================================================== */

async function loadData() {
  console.log("Carico CSV da:", CSV_URL);

  const response = await fetch(CSV_URL);
  const text = await response.text();

  console.log("CSV caricato, lunghezza:", text.length);

  const rows = text.trim().split("\n");
  const headers = rows[0].split(",").map(h => h.trim());

  // reset
  markersData.forEach(o => map.removeLayer(o.marker));
  markersData = [];

  for (let i = 1; i < rows.length; i++) {
    const values = rows[i].split(",");
    const row = {};
    headers.forEach((h, idx) => row[h] = values[idx]);

    const lat = parseFloat(row["Latitudine"]);
    const lng = parseFloat(row["Longitudine"]);

    if (isNaN(lat) || isNaN(lng)) continue;

    const marker = L.circleMarker([lat, lng], {
      radius: 7,
      weight: 1,
      color: "#000",
      fillOpacity: 0.9
    }).addTo(map);

    marker.bindPopup(`
      <b>Data:</b> ${row["Data"] || "—"}<br>
      <b>Età:</b> ${row["Età"] || "—"}
    `);

    markersData.push({
      marker,
      data: normalize(row["Data"]),
      age: normalize(row["Età"])
    });
  }

  applyMode();
}

/* ======================================================
   MODALITÀ & COLORI
====================================================== */

function applyMode() {
  const categories = [];
  const categoryIndex = {};

  markersData.forEach(obj => {
    let category = null;

    if (currentMode === "date") {
      category = getYearFromItalianDate(obj.data);
    } else {
      category = obj.age;
    }

    if (!category) category = "Non disponibile";

    if (!(category in categoryIndex)) {
      categoryIndex[category] = categories.length;
      categories.push(category);
    }

    obj.category = category;
  });

  activeCategories = new Set(categories);

  markersData.forEach(obj => {
    const idx = categoryIndex[obj.category];
    obj.marker.setStyle({
      fillColor: colorForCategory(obj.category, idx)
    });
  });

  updateLegend(categories, categoryIndex);
}

/* ======================================================
   LEGENDA CLICCABILE
====================================================== */

function updateLegend(categories, categoryIndex) {
  const legend = document.getElementById("legend");
  legend.innerHTML = `<b>${
    currentMode === "date" ? "Anno di avvistamento" : "Età presunta"
  }</b><br>`;

  categories.forEach(cat => {
    const idx = categoryIndex[cat];
    const color = colorForCategory(cat, idx);

    const div = document.createElement("div");
    div.className = "legend-item";
    div.innerHTML = `<span style="background:${color}"></span>${cat}`;

    div.onclick = () => {
      if (activeCategories.has(cat)) {
        activeCategories.delete(cat);
        div.classList.add("disabled");
      } else {
        activeCategories.add(cat);
        div.classList.remove("disabled");
      }

      markersData.forEach(obj => {
        if (obj.category === cat) {
          if (activeCategories.has(cat)) {
            obj.marker.addTo(map);
          } else {
            map.removeLayer(obj.marker);
          }
        }
      });
    };

    legend.appendChild(div);
  });
}

/* ======================================================
   EVENTI
====================================================== */

document.getElementById("modeSelect").addEventListener("change", e => {
  currentMode = e.target.value;
  applyMode();
});

/* ======================================================
   AVVIO
====================================================== */

loadData();
</script>

</body>
</html>
