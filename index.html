<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Mappa avvistamenti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse (CSV) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }

    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 8px;
      z-index: 1000;
      font-family: sans-serif;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

    .legend {
      background: white;
      padding: 8px;
      font-family: sans-serif;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      line-height: 1.4em;
    }

    .legend i {
      width: 14px;
      height: 14px;
      float: left;
      margin-right: 6px;
      opacity: 0.9;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div class="controls">
  <b>Colora per:</b><br>
  <select id="modeSelect">
    <option value="eta">Et√† presunta</option>
    <option value="data">Data avvistamento</option>
  </select>
</div>

<script>
/* ================== CONFIG ================== */

// üîÅ INCOLLA QUI IL TUO URL CSV PUBBLICATO
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQV5vkNteaZi31wNAuMVEvaBVyETWETC9C3R01wmtB_JaoSgXPasKPS9ZdjrrN9j4gPjv-_ZoOeWpkS/pub?gid=602128412&single=true&output=csv";

// colori per anno
const yearColors = [
  "#1f78b4",
  "#33a02c",
  "#e31a1c",
  "#ff7f00",
  "#6a3d9a",
  "#b15928"
];

/* ================== MAPPA ================== */

const map = L.map("map").setView([45.1370, 7.0480], 10);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

const markers = L.layerGroup().addTo(map);

/* ================== LEGENDA ================== */

const legend = L.control({ position: "bottomright" });
legend.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  return div;
};
legend.addTo(map);

const legendYears = new Set();

/* ================== FUNZIONI SUPPORTO ================== */

function getYear(dateStr) {
  if (!dateStr || dateStr === "undefined") return null;
  const d = new Date(dateStr);
  return isNaN(d) ? null : d.getFullYear();
}

function getColorByEta(eta) {
  if (!eta || eta === "undefined") return "#999999";
  eta = eta.toLowerCase();
  if (eta.includes("adult")) return "#1f78b4";
  if (eta.includes("giovan")) return "#33a02c";
  if (eta.includes("non")) return "#e31a1c";
  return "#999999";
}

function getColorByYear(year, yearMap) {
  if (!year) return "#999999";
  return yearMap[year] || "#999999";
}

/* ================== LEGENDA ================== */

function updateLegend(mode, yearMap = {}) {
  const div = legend.getContainer();
  div.innerHTML = "<b>Legenda</b><br>";

  if (mode === "eta") {
    div.innerHTML += `
      <i style="background:#1f78b4"></i> Adulto<br>
      <i style="background:#33a02c"></i> Giovane<br>
      <i style="background:#e31a1c"></i> Non determinato<br>
      <i style="background:#999999"></i> Non disponibile
    `;
  }

  if (mode === "data") {
    Object.keys(yearMap).sort().forEach(year => {
      div.innerHTML +=
        `<i style="background:${yearMap[year]}"></i> ${year}<br>`;
    });

    div.innerHTML +=
      `<i style="background:#999999"></i> Data non disponibile`;
  }
}

/* ================== CARICAMENTO DATI ================== */

async function loadData(mode = "eta") {
  const response = await fetch(CSV_URL);
  const csvText = await response.text();
  const rows = Papa.parse(csvText, { header: true }).data;

  markers.clearLayers();
  legendYears.clear();

  const years = [];

  rows.forEach(row => {
    const year = getYear(row["Giorno"]);
    if (year) years.push(year);
  });

  const uniqueYears = [...new Set(years)].sort();
  const yearMap = {};
  uniqueYears.forEach((y, i) => {
    yearMap[y] = yearColors[i % yearColors.length];
  });

  rows.forEach(row => {
    const lat = parseFloat(row["Latitudine"]);
    const lng = parseFloat(row["Longitudine"]);

    if (isNaN(lat) || isNaN(lng)) return;

    let color = "#999999";

    if (mode === "eta") {
      color = getColorByEta(row["Et√†"]);
    }

    if (mode === "data") {
      const year = getYear(row["Giorno"]);
      color = getColorByYear(year, yearMap);
    }

    const marker = L.circleMarker([lat, lng], {
      radius: 6,
      fillColor: color,
      color: "#000",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.85
    });

    marker.bindPopup(`
      <b>Data:</b> ${row["Giorno"] || "Non disponibile"}<br>
      <b>Et√†:</b> ${row["Et√†"] || "Non disponibile"}
    `);

    markers.addLayer(marker);
  });

  updateLegend(mode, yearMap);
}

/* ================== EVENTI ================== */

document.getElementById("modeSelect").addEventListener("change", e => {
  loadData(e.target.value);
});

// caricamento iniziale
loadData("eta");

</script>

</body>
</html>
