<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Mappa avvistamenti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }

    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 8px;
      z-index: 1000;
      font-family: sans-serif;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

    .legend {
      background: white;
      padding: 8px;
      font-family: sans-serif;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      line-height: 1.4em;
    }

    .legend i {
      width: 14px;
      height: 14px;
      float: left;
      margin-right: 6px;
      opacity: 0.9;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div class="controls">
  <b>Colora per:</b><br>
  <select id="modeSelect">
    <option value="eta">Età presunta</option>
    <option value="data">Data avvistamento</option>
  </select>
</div>

<script>
/* ================== CONFIG ================== */

const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQV5vkNteaZi31wNAuMVEvaBVyETWETC9C3R01wmtB_JaoSgXPasKPS9ZdjrrN9j4gPjv-_ZoOeWpkS/pub?gid=602128412&single=true&output=csv";

const palette = [
  "#1f78b4", "#33a02c", "#e31a1c", "#ff7f00",
  "#6a3d9a", "#b15928", "#a6cee3", "#b2df8a"
];

const NO_DATA_COLOR = "#999999";

/* ================== MAPPA ================== */

const map = L.map("map").setView([45.1370, 7.0480], 10);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

const markers = L.layerGroup().addTo(map);

/* ================== LEGENDA ================== */

const legend = L.control({ position: "bottomright" });
legend.onAdd = function () {
  return L.DomUtil.create("div", "legend");
};
legend.addTo(map);

/* ================== UTILS ================== */

// parse DD/MM/YYYY
function getYearFromItalianDate(dateStr) {
  if (!dateStr || dateStr === "undefined") return null;
  const parts = dateStr.split("/");
  if (parts.length !== 3) return null;
  const year = parseInt(parts[2], 10);
  return isNaN(year) ? null : year;
}

/* ================== LEGENDA ================== */

function updateLegend(title, valueColorMap) {
  const div = legend.getContainer();
  div.innerHTML = `<b>${title}</b><br>`;

  Object.keys(valueColorMap).forEach(key => {
    div.innerHTML +=
      `<i style="background:${valueColorMap[key]}"></i> ${key}<br>`;
  });

  div.innerHTML +=
    `<i style="background:${NO_DATA_COLOR}"></i> Non disponibile`;
}

/* ================== LOAD DATA ================== */

async function loadData(mode) {
  const response = await fetch(CSV_URL);
  const csvText = await response.text();
  const rows = Papa.parse(csvText, { header: true }).data;

  markers.clearLayers();

  const valueSet = new Set();

  rows.forEach(row => {
    if (mode === "data") {
      const year = getYearFromItalianDate(row["Giorno"]);
      if (year) valueSet.add(year.toString());
    }
    if (mode === "eta") {
      const eta = row["Età"];
      if (eta && eta !== "undefined") valueSet.add(eta);
    }
  });

  const values = Array.from(valueSet).sort();
  const colorMap = {};

  values.forEach((v, i) => {
    colorMap[v] = palette[i % palette.length];
  });

  rows.forEach(row => {
    const lat = parseFloat(row["Latitudine"]);
    const lng = parseFloat(row["Longitudine"]);
    if (isNaN(lat) || isNaN(lng)) return;

    let color = NO_DATA_COLOR;

    if (mode === "data") {
      const year = getYearFromItalianDate(row["Giorno"]);
      if (year && colorMap[year]) color = colorMap[year];
    }

    if (mode === "eta") {
      const eta = row["Età"];
      if (eta && colorMap[eta]) color = colorMap[eta];
    }

    const marker = L.circleMarker([lat, lng], {
      radius: 6,
      fillColor: color,
      color: "#000",
      weight: 1,
      fillOpacity: 0.85
    });

    marker.bindPopup(`
      <b>Data:</b> ${row["Giorno"] || "Non disponibile"}<br>
      <b>Età:</b> ${row["Età"] || "Non disponibile"}
    `);

    markers.addLayer(marker);
  });

  updateLegend(
    mode === "data" ? "Anno avvistamento" : "Età presunta",
    colorMap
  );
}

/* ================== EVENTI ================== */

document.getElementById("modeSelect").addEventListener("change", e => {
  loadData(e.target.value);
});

// avvio
loadData("eta");

</script>

</body>
</html>
